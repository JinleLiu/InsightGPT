import openai
import os
import re
import pandas as pd

openai.api_key = os.environ.get("OPENAI_API_KEY")

# Evaluation prompt template based on G-Eval
EVALUATION_PROMPT_TEMPLATE = """
You will be given a response generated by the VLLM and its corresponding ground-truth label. Your task is to rate the response on one metric.
Please make sure you read and understand these instructions very carefully. 
Please keep this document open while reviewing, and refer to it as needed.

Evaluation Criteria:

{criteria}

Evaluation Steps:

{steps}

Example:

Ground-truth Response:

{label}

Response:

{response}

Evaluation Form (scores ONLY):

- {metric_name}
"""

# Metric 1: Relevance

RELEVANCY_SCORE_CRITERIA = """
Relevance(1-5) - selection of important content from the ground-truth response. \
The response should be highly semantically similar to the ground-truth response. \
Annotators were instructed to penalize response which contained unrelated information.
"""

RELEVANCY_SCORE_STEPS = """
1. Read the response and the ground-truth response carefully.
2. Compare the response to the ground-truth response and identify the main points of the ground-truth response.
3. Assessing the degree of similarity between response and ground-truth response, and how much irrelevant or redundant information the response contains.
4. Assign a relevance score from 1 to 5.
"""

# Metric 2: Faithfulness

COHERENCE_SCORE_CRITERIA = """
Coherence(1-5) - the factual alignment between the response and the ground-truth response. \
This metric examines whether there is an illusion or fictionalized description in the response that does not match the image. \
It is calculated by comparing the response to the ground-truth response, and if this score is low, \
reflecting the fact that the LLM response does not follow the physical laws of the real world, \
then the more likely the response is to be hallucinatory.
"""

COHERENCE_SCORE_STEPS = """
1. Read the ground-truth response carefully and identify the main topic and key points.
2. Read the content of the response carefully. Check if the response contains any factual errors that are not supported by the ground-truth response.
3. Assign a score for faithfulness on a scale of 1 to 5, where 1 is the lowest and 5 is the highest based on the Evaluation Criteria.
"""

# Metric 3: Correctness of the Reasoning Details

CONSISTENCY_SCORE_CRITERIA = """
Consistency(1-5) - the correctness and rationality of logic and reasoning in response. \
The reasoning process in the response needs to be verified for plausibility and correctness based on the ground-truth response. \
Annotators were also asked to penalize response that contained incorrect reasoning process.
"""

CONSISTENCY_SCORE_STEPS = """
1. Read the ground-truth response carefully and identify the main reasoning process and conclusion it presents.
2. Read the response and compare it to the ground-truth response. Check if the reasoning process and conclusion in response is correct and reasonable.
3. Assign a score for correctness of the reasoning details based on the Evaluation Criteria.
"""


def get_geval_score(
    criteria: str, steps: str, response: str, ground_truth_response: str, metric_name: str
):
    prompt = EVALUATION_PROMPT_TEMPLATE.format(
        criteria=criteria,
        steps=steps,
        metric_name=metric_name,
        document=document,
        summary=summary,
    )
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0,
        max_tokens=5,
        top_p=1,
        frequency_penalty=0,
        presence_penalty=0,
    )
    return response.choices[0].message.content


evaluation_metrics = {
    "Relevance": (RELEVANCY_SCORE_CRITERIA, RELEVANCY_SCORE_STEPS),
    "Faithfulness": (COHERENCE_SCORE_CRITERIA, COHERENCE_SCORE_STEPS),
    "Correctness of the Reasoning Details": (CONSISTENCY_SCORE_CRITERIA, CONSISTENCY_SCORE_STEPS)
}

response = r"The target vehicle shown in the lower right corner of the image appears to be violating traffic rules by not yielding to the right-of-way to an oncoming vehicle. Let's break down the sequence of events and road markings to explain this violation step by step:\n\n1. **Road Markings and Signal Lights:**\n   - In the upper left and upper right images, we can observe that the target vehicle is positioned on a crosswalk, which is typically where vehicles should yield to pedestrians.\n   - The signal lights in these images are red, indicating that the vehicle should not be proceeding through the intersection.\n\n2. **Trajectory of the Target Vehicle:**\n   - In the upper left image, we see the target vehicle has stopped on the crosswalk, which is appropriate when the signal is red.\n   - In the upper right image, the vehicle is in the process of crossing the crosswalk, but it does not appear to be yielding to any vehicles that may be coming from the right.\n\n3. **Potential Violation:**\n   - The vehicle's trajectory across the crosswalk, in combination with the red signal light, suggests that the vehicle should be stopped and not crossing until the signal turns green.\n   - By continuing to cross or proceed through the intersection, the vehicle"
ground_truth_response = r"Based on the content of the image, it appears that the target vehicle has violated a road marking, specifically the pedestrian crossing lines. This violation is evident in the lower right corner of the image, where the vehicle is shown to be in the pedestrian crossing area.In the upper left, upper right, and lower left images, the vehicle is shown in motion, and it is clear that the vehicle is not following the road markings. The road markings are designed to indicate where pedestrians should cross the street safely, and the vehicle is positioned within this area, which is a violation of traffic rules.The status of the signal lights is not visible in the image, but it is important to note that traffic signals are typically used to control the flow of traffic and ensure that vehicles do not enter crosswalks when pedestrians are crossing. If the vehicle had obeyed the traffic signals, it would not have entered the pedestrian crossing area.Therefore, the violation exists because the vehicle has not followed the road markings and has entered the pedestrian crossing area, which is a designated space for pedestrians to cross the street safely. This action poses a risk to pedestrian safety and is a violation of traffic regulations."

data = {"Evaluation Type": [], "Score": []}

for eval_type, (criteria, steps) in evaluation_metrics.items():
    data["Evaluation Type"].append(eval_type)
    result = get_geval_score(criteria, steps, response, ground_truth_response, eval_type)
    score_num = int(result.strip())
    data["Score"].append(score_num)

pivot_df = pd.DataFrame(data, index=None).pivot(
    index="Evaluation Type", values="Score"
)
styled_pivot_df = pivot_df.style.apply(highlight_max, axis=1)
display(styled_pivot_df)